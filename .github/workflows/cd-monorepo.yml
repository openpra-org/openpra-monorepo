name: "CD: Monorepo â€” Deploy Stack"

on:
  release:
    types: [published]

env:
  REGISTRY: ghcr.io
  OWNER: ${{ github.repository_owner }}
  STACK_NAME: openpra
  # Defaults
  NUM_FRONTENDS: 1
  DEPLOYMENT_FRONTEND_POOL: "node.labels.high_performance == true"

jobs:
  deploy:
    runs-on: [self-hosted, monorepo]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Note: To strictly enforce "only CODEOWNERS", you would need to check github.actor against a list.
      # Since CODEOWNERS file uses roles, we rely on GitHub's permission system for Release creation.

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare environment variables
        run: |
          REPO_LOWER=$(echo "${OWNER}" | tr '[:upper:]' '[:lower:]')
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)

          # Use the short SHA to identify the image built by the CI pipeline
          echo "IMAGE_FRONTEND=${REGISTRY}/${REPO_LOWER}/openpra-frontend:${SHORT_SHA}" >> $GITHUB_ENV

          echo "Deploying image: ${REGISTRY}/${REPO_LOWER}/openpra-frontend:${SHORT_SHA}"

      - name: Create secrets directory
        working-directory: docker
        run: mkdir -p secrets

      - name: Create Cloudflare Tunnel Token secret
        working-directory: docker
        run: echo "${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}" > secrets/CLOUDFLARE_TUNNEL_TOKEN

      - name: Deploy Stack
        working-directory: docker
        run: |
          docker stack deploy -c cd-stack.yml ${{ env.STACK_NAME }} --with-registry-auth
