name: "CI/CD: Build, Publish & Deploy"

on:
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - "**"
  workflow_dispatch:

permissions:
  contents: read

env:
  REGISTRY: docker.io
  OWNER: ${{ secrets.DOCKERHUB_USERNAME }}
  # Stack Configuration Defaults
  STACK_NAME: openpra
  NUM_FRONTENDS: 1
  NUM_BACKENDS: 1
  NUM_BROKERS: 1
  NUM_WORKERS: 1
  CI_BUILD_TYPE: production
  CI_DEBUG: false

jobs:
  # -----------------------------------------------------------------------------
  # JOB 1: BUILD & PUSH (Runs on GitHub Runners)
  # -----------------------------------------------------------------------------
  build-and-push:
    runs-on: ubuntu-latest
    # Define outputs so they can be read by the Deploy job
    outputs:
      branch_slug: ${{ steps.prep.outputs.branch_slug }}
      repo_lower: ${{ steps.prep.outputs.repo_lower }}
      short_sha: ${{ steps.prep.outputs.short_sha }}
      channel_tag: ${{ steps.prep.outputs.channel_tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20.17.0"

      - name: Ensure pnpm available
        run: npx -y pnpm@10.19.0 --version

      - name: Install dependencies
        run: npx -y pnpm@10.19.0 install --ignore-scripts --no-frozen-lockfile

      - name: Build server apps
        run: |
          npx -y pnpm@10.19.0 nx build web-backend --no-cloud
          npx -y pnpm@10.19.0 nx build microservice-job-broker --no-cloud
          npx -y pnpm@10.19.0 nx run frontend-web-editor:build:production --no-cloud

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Prepare tags
        id: prep
        # explicitly pass the secret here to ensure the shell sees it
        env:
          DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          # 1. Handle Repository Owner (Username)
          if [ -z "$DOCKER_USER" ]; then
            echo "âŒ Error: DOCKERHUB_USERNAME secret is missing!"
            exit 1
          fi
          # Force to lowercase
          REPO_LOWER=$(echo "${DOCKER_USER}" | tr '[:upper:]' '[:lower:]')
          echo "repo_lower=$REPO_LOWER" >> $GITHUB_OUTPUT
          echo "âœ… Debug: Repo Owner is '$REPO_LOWER'"

          # 2. Handle Branch Slug
          # Uses GITHUB_HEAD_REF for PRs, or GITHUB_REF_NAME for pushes
          RAW_BRANCH="${GITHUB_HEAD_REF:-${GITHUB_REF_NAME}}"
          # Replace slashes with dashes and lowercase it
          BRANCH_SLUG=$(echo "${RAW_BRANCH}" | tr '/' '-' | tr '[:upper:]' '[:lower:]')
          echo "branch_slug=$BRANCH_SLUG" >> $GITHUB_OUTPUT
          echo "âœ… Debug: Branch Slug is '$BRANCH_SLUG'"

          # 3. Handle Commit SHA
          SHORT_SHA=${GITHUB_SHA::7}
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

          # 4. Handle Channel Tag (latest vs preview)
          if [ "${GITHUB_REF}" = "refs/heads/main" ]; then
            echo "channel_tag=latest" >> $GITHUB_OUTPUT
          else
            echo "channel_tag=preview" >> $GITHUB_OUTPUT
          fi

      # --- CONTEXT PREP & DOCKER BUILD STEPS ---

      - name: Prepare web-backend context
        run: |
          mkdir -p docker-context/web-backend
          cp -r dist/packages/web-backend/* docker-context/web-backend/
          cp packages/web-backend/package.json docker-context/web-backend/package.json
          node -e '
            const fs=require("fs"); const pth="docker-context/web-backend/package.json";
            const pkg=JSON.parse(fs.readFileSync(pth,"utf8"));
            if(pkg.dependencies){ for(const [k,v] of Object.entries({...pkg.dependencies})) if(typeof v==="string" && v.startsWith("workspace:")) delete pkg.dependencies[k]; }
            if(pkg.devDependencies){ for(const [k,v] of Object.entries({...pkg.devDependencies})) if(typeof v==="string" && v.startsWith("workspace:")) delete pkg.devDependencies[k]; }
            fs.writeFileSync(pth, JSON.stringify(pkg,null,2));
          '
          cat > docker-context/web-backend/Dockerfile <<'EOF'
          FROM node:20-slim
          WORKDIR /app
          RUN corepack enable && corepack prepare pnpm@10.19.0 --activate
          ENV PNPM_ENABLE_PREPOSTINSTALL_SCRIPTS=true
          COPY package.json ./
          RUN pnpm install --prod --no-frozen-lockfile
          COPY . ./
          ENV NODE_ENV=production
          EXPOSE 8000
          CMD ["node","main.js"]
          EOF

      - name: Prepare job-broker context
        run: |
          mkdir -p docker-context/job-broker
          cp -r dist/packages/microservice/job-broker/* docker-context/job-broker/
          cp packages/microservice/job-broker/package.json docker-context/job-broker/package.json
          node -e '
            const fs=require("fs"); const pth="docker-context/job-broker/package.json";
            const pkg=JSON.parse(fs.readFileSync(pth,"utf8"));
            if(pkg.dependencies){ for(const [k,v] of Object.entries({...pkg.dependencies})) if(typeof v==="string" && v.startsWith("workspace:")) delete pkg.dependencies[k]; }
            if(pkg.devDependencies){ for(const [k,v] of Object.entries({...pkg.devDependencies})) if(typeof v==="string" && v.startsWith("workspace:")) delete pkg.devDependencies[k]; }
            fs.writeFileSync(pth, JSON.stringify(pkg,null,2));
          '
          cat > docker-context/job-broker/Dockerfile <<'EOF'
          FROM node:20-slim
          WORKDIR /app
          RUN corepack enable && corepack prepare pnpm@10.19.0 --activate
          ENV PNPM_ENABLE_PREPOSTINSTALL_SCRIPTS=true
          COPY package.json ./
          RUN pnpm install --prod --no-frozen-lockfile
          COPY . ./
          ENV NODE_ENV=production
          EXPOSE 3000
          CMD ["node","main.js"]
          EOF

      - name: Build and push web-backend
        uses: docker/build-push-action@v6
        with:
          context: docker-context/web-backend
          file: docker-context/web-backend/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ steps.prep.outputs.repo_lower }}/openpra-web-backend:${{ steps.prep.outputs.short_sha }}
            ${{ env.REGISTRY }}/${{ steps.prep.outputs.repo_lower }}/openpra-web-backend:${{ steps.prep.outputs.branch_slug }}
            ${{ env.REGISTRY }}/${{ steps.prep.outputs.repo_lower }}/openpra-web-backend:${{ steps.prep.outputs.channel_tag }}

      - name: Build and push job-broker
        uses: docker/build-push-action@v6
        with:
          context: docker-context/job-broker
          file: docker-context/job-broker/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ steps.prep.outputs.repo_lower }}/openpra-job-broker:${{ steps.prep.outputs.short_sha }}
            ${{ env.REGISTRY }}/${{ steps.prep.outputs.repo_lower }}/openpra-job-broker:${{ steps.prep.outputs.branch_slug }}
            ${{ env.REGISTRY }}/${{ steps.prep.outputs.repo_lower }}/openpra-job-broker:${{ steps.prep.outputs.channel_tag }}

      - name: Prepare frontend context
        run: |
          mkdir -p docker-context/frontend/html
          cp -r dist/packages/frontend/web-editor/* docker-context/frontend/html/
          cp docker/nginx-frontend.production.conf docker-context/frontend/nginx-frontend.conf
          cat > docker-context/frontend/Dockerfile <<'EOF'
          FROM nginx:1.25-alpine
          COPY nginx-frontend.conf /etc/nginx/conf.d/default.conf
          COPY html/ /usr/share/nginx/html/
          EXPOSE 80
          EOF

      - name: Build and push frontend
        uses: docker/build-push-action@v6
        with:
          context: docker-context/frontend
          file: docker-context/frontend/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ steps.prep.outputs.repo_lower }}/openpra-frontend:${{ steps.prep.outputs.short_sha }}
            ${{ env.REGISTRY }}/${{ steps.prep.outputs.repo_lower }}/openpra-frontend:${{ steps.prep.outputs.branch_slug }}
            ${{ env.REGISTRY }}/${{ steps.prep.outputs.repo_lower }}/openpra-frontend:${{ steps.prep.outputs.channel_tag }}

  # -----------------------------------------------------------------------------
  # JOB 2: DEPLOY (Runs on Self-Hosted Swarm Runner)
  # -----------------------------------------------------------------------------
  deploy:
    needs: build-and-push
    runs-on: [self-hosted, monorepo]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Configure and Debug Environment
        run: |
          # 1. Retrieve outputs from build job (using Contexts to be safe)
          REPO_LOWER="${{ needs.build-and-push.outputs.repo_lower }}"
          BRANCH_SLUG="${{ needs.build-and-push.outputs.branch_slug }}"
          REGISTRY_URL="${{ env.REGISTRY }}"

          # 2. Check for empty values (This is likely where it fails)
          if [ -z "$REPO_LOWER" ]; then echo "âŒ Error: REPO_LOWER is empty!"; exit 1; fi
          if [ -z "$BRANCH_SLUG" ]; then echo "âŒ Error: BRANCH_SLUG is empty!"; exit 1; fi

          # 3. Construct Image URLs
          # We construct them here to ensure no variables are missing
          IMG_FRONTEND="${REGISTRY_URL}/${REPO_LOWER}/openpra-frontend:${BRANCH_SLUG}"
          IMG_BACKEND="${REGISTRY_URL}/${REPO_LOWER}/openpra-web-backend:${BRANCH_SLUG}"
          IMG_BROKER="${REGISTRY_URL}/${REPO_LOWER}/openpra-job-broker:${BRANCH_SLUG}"

          # 4. Print them to the logs for inspection
          echo "----------------------------------------"
          echo "ðŸ” DEBUG: Generated Image References:"
          echo "Frontend: $IMG_FRONTEND"
          echo "Backend:  $IMG_BACKEND"
          echo "Broker:   $IMG_BROKER"
          echo "Stack:    ${{ env.STACK_NAME }}"
          echo "----------------------------------------"

          # 5. Export to GITHUB_ENV for the next step
          echo "IMAGE_FRONTEND=$IMG_FRONTEND" >> "$GITHUB_ENV"
          echo "IMAGE_BACKEND=$IMG_BACKEND" >> "$GITHUB_ENV"
          echo "IMAGE_JOB_BROKER=$IMG_BROKER" >> "$GITHUB_ENV"
          echo "BRANCH_SLUG=$BRANCH_SLUG" >> "$GITHUB_ENV"

      - name: Create secrets directory
        working-directory: docker
        run: mkdir -p secrets

      - name: Create Secrets Files
        working-directory: docker
        run: |
          if [ -n "${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}" ]; then
            printf '%s' "${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}" > secrets/CLOUDFLARE_TUNNEL_TOKEN
          fi
          if [ -n "${{ secrets.JWT_SECRET }}" ]; then
             printf '%s' "${{ secrets.JWT_SECRET }}" > secrets/JWT_SECRET
          fi

      - name: Deploy Stack
        working-directory: docker
        # Explicitly passing environment variables to the command line to prevent shell missing them
        env:
          IMAGE_FRONTEND: ${{ env.IMAGE_FRONTEND }}
          IMAGE_BACKEND: ${{ env.IMAGE_BACKEND }}
          IMAGE_JOB_BROKER: ${{ env.IMAGE_JOB_BROKER }}
          BRANCH_SLUG: ${{ env.BRANCH_SLUG }}
        run: |
          # The -c flag needs the full path or relative path. 
          # Since we are in 'docker' directory, 'cd-stack.yml' should be there.
          docker stack deploy -c cd-stack.yml ${{ env.STACK_NAME }} --with-registry-auth

      - name: ðŸš€ Deployment Summary
        if: success()
        run: |
          echo "### âœ… Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "Deployed to **${{ env.BRANCH_SLUG }}** environment." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ–¥ï¸ Frontend | https://${{ env.BRANCH_SLUG }}.openpra.org |" >> $GITHUB_STEP_SUMMARY
          echo "| âš™ï¸ Backend | https://${{ env.BRANCH_SLUG }}.openpra.org/api |" >> $GITHUB_STEP_SUMMARY
