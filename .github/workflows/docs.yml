name: 'Docs: Unified TypeScript + C++'

on:
  push:
    branches:
      - fix/docs-and-cd-pipeline
    paths:
      - 'packages/docs-md/**'
      - 'packages/mef-types/**'
      - 'packages/shared-types/**'
      - 'packages/shared-sdk/**'
      - 'packages/frontend/web-editor/src/utils/**'
      - 'packages/engine/scram/**'
      - '.github/workflows/docs.yml'
      - '.dockerignore'
      - 'pnpm-workspace.yaml'
      - 'pnpm-lock.yaml'
      - 'nx.json'
      - 'tsconfig.base.json'
      - 'package.json'
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  build-and-deploy:
    concurrency:
      group: docs-${{ github.ref }}
      cancel-in-progress: true
    runs-on: monorepo-runner
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js 20 + pnpm
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # Removed pnpm cache here because it requires pnpm to be on PATH during this step
      - name: Ensure pnpm available
        run: npx -y pnpm@10.19.0 --version

      - name: Install root dependencies (skip lifecycle scripts)
        run: npx -y pnpm@10.19.0 install --no-frozen-lockfile --ignore-scripts

      - name: Install Doxygen
        run: |
          sudo DEBIAN_FRONTEND=noninteractive apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y doxygen graphviz

      - name: Install Doxybook2
        run: |
          sudo DEBIAN_FRONTEND=noninteractive apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y unzip
          curl -sSL -o doxybook2.zip https://github.com/matusnovak/doxybook2/releases/download/v1.5.0/doxybook2-linux-amd64-v1.5.0.zip
          # Unpack into /usr/local so the binary lands in /usr/local/bin
          sudo unzip -o doxybook2.zip -d /usr/local
          sudo chmod +x /usr/local/bin/doxybook2 || true
          doxybook2 --version

      - name: Build unified Markdown docs (VitePress)
        # Nx Cloud temporarily disabled â€” retain config here for quick re-enable
        env:
          NX_NO_CLOUD: 'true'
          VITEPRESS_BASE: '/${{ github.event.repository.name }}/'
          # NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
          # NX_BRANCH: ${{ github.ref_name }}
          # NX_RUN_GROUP: docs-${{ github.run_id }}
          # TESTING SSL
        run: npx -y pnpm@10.19.0 nx run docs-md:site:build --no-cloud

      - name: Link check
        env:
          VITEPRESS_BASE: '/${{ github.event.repository.name }}/'
        run: npx -y pnpm@10.19.0 nx run docs-md:site:link-check --no-cloud

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Determine branch-based domain and image tag
        id: vars
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          # Sanitize branch name for domain (replace / with -)
          SANITIZED_BRANCH=$(echo "$BRANCH_NAME" | sed 's/\//-/g')
          
          if [ "$BRANCH_NAME" = "main" ]; then
            DOMAIN="docs.openpra.org"
            IMAGE_TAG="latest"
          else
            DOMAIN="docs-${SANITIZED_BRANCH}.openpra.org"
            IMAGE_TAG="${SANITIZED_BRANCH}"
          fi
          
          echo "domain=$DOMAIN" >> $GITHUB_OUTPUT
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "sanitized_branch=$SANITIZED_BRANCH" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: packages/docs-md/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/openpra-docs:${{ steps.vars.outputs.image_tag }}
            ghcr.io/${{ github.repository_owner }}/openpra-docs:${{ github.sha }}
          build-args: |
            VITEPRESS_BASE=/
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to Docker Swarm
        run: |
          DOMAIN="${{ steps.vars.outputs.domain }}"
          IMAGE_TAG="${{ steps.vars.outputs.image_tag }}"
          STACK_NAME="docs-${{ steps.vars.outputs.sanitized_branch }}"
          BRANCH_SLUG="${{ steps.vars.outputs.sanitized_branch }}"
          
          # Export variables for docker stack
          export IMAGE_DOCS="ghcr.io/${{ github.repository_owner }}/openpra-docs:${IMAGE_TAG}"
          export DOMAIN="${DOMAIN}"
          export BRANCH_SLUG="${BRANCH_SLUG}"
          
          # Deploy stack with registry auth
          docker stack deploy \
            --with-registry-auth \
            --compose-file docker/docs-stack.yml \
            ${STACK_NAME}
          
          echo "Documentation deployed to https://${DOMAIN}"
