networks:
  db_net:
    driver: overlay
    attachable: true
  svc_net:
    driver: overlay
    attachable: true
  rmq_net:
    driver: overlay
    attachable: true

configs:
  rabbitmq_plugins:
    file: configs/rabbitmq/enabled_plugins
  rabbitmq_conf:
    file: configs/rabbitmq/rabbitmq.conf

x-base-shared-vols: &volumes-timezone
  volumes:
    - "/etc/localtime:/etc/localtime:ro"
    - "/etc/timezone:/etc/timezone:ro"

x-base-replicated: &shared-replicated
  mode: replicated
  update_config:
    parallelism: 16
    delay: 1s
    failure_action: rollback
    order: stop-first
    monitor: 120s
  rollback_config:
    parallelism: 16
    delay: 1s
    failure_action: continue
    order: stop-first
    monitor: 120s

secrets:
  CLOUDFLARE_TUNNEL_TOKEN:
    file: secrets/CLOUDFLARE_TUNNEL_TOKEN

services:
  cloudflared:
    image: cloudflare/cloudflared:latest
    command:
      - tunnel
      - --no-autoupdate
      - run
      - --token-file
      - /run/secrets/CLOUDFLARE_TUNNEL_TOKEN
    secrets:
      - CLOUDFLARE_TUNNEL_TOKEN
    networks:
      - svc_net
      - rmq_net
      - db_net
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.high_performance == true
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3

  frontend:
    image: ${IMAGE_FRONTEND}
    <<: *volumes-timezone
    networks:
      - svc_net
    deploy:
      <<: *shared-replicated
      replicas: ${NUM_FRONTENDS}
      placement:
        max_replicas_per_node: 1
        constraints:
          - "${DEPLOYMENT_FRONTEND_POOL}"
      restart_policy:
        condition: any
        delay: 10s
        max_attempts: 5

  rabbitmq:
    image: rabbitmq:management-alpine
    volumes:
      - "/etc/localtime:/etc/localtime:ro"
      - "/etc/timezone:/etc/timezone:ro"
    networks:
      - svc_net
      - rmq_net
    configs:
      - source: rabbitmq_plugins
        target: /etc/rabbitmq/enabled_plugins
      - source: rabbitmq_conf
        target: /etc/rabbitmq/rabbitmq.conf
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.high_performance == true
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3

  mongodb:
    image: mongo:latest
    networks:
      - db_net
    volumes:
      - "/etc/localtime:/etc/localtime:ro"
      - "/etc/timezone:/etc/timezone:ro"
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.high_performance == true
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3
