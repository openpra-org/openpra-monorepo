version: "3.8"

networks:
  traefik-public:
    external: true

services:
  docs:
    image: ${IMAGE_DOCS}
    volumes:
      - "/etc/localtime:/etc/localtime:ro"
      - "/etc/timezone:/etc/timezone:ro"
    networks:
      - traefik-public
    deploy:
      mode: replicated
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: stop-first
        monitor: 30s
      rollback_config:
        parallelism: 1
        delay: 10s
        failure_action: continue
        order: stop-first
        monitor: 30s
      restart_policy:
        condition: any
        delay: 10s
        max_attempts: 5
      labels:
        - "traefik.enable=true"
        - "traefik.docker.network=traefik-public"
        - "traefik.constraint-label=traefik-public"
        # HTTP Router with redirect
        - "traefik.http.routers.${BRANCH_SLUG}-docs-http.rule=Host(`${DOMAIN}`)"
        - "traefik.http.routers.${BRANCH_SLUG}-docs-http.entrypoints=http"
        - "traefik.http.routers.${BRANCH_SLUG}-docs-http.middlewares=${BRANCH_SLUG}-docs-https-redirect,gzip"
        - "traefik.http.routers.${BRANCH_SLUG}-docs-http.service=${BRANCH_SLUG}-docs"
        # HTTPS Router
        - "traefik.http.routers.${BRANCH_SLUG}-docs.rule=Host(`${DOMAIN}`)"
        - "traefik.http.routers.${BRANCH_SLUG}-docs.entrypoints=https"
        - "traefik.http.routers.${BRANCH_SLUG}-docs.tls.certresolver=cloudflare"
        - "traefik.http.routers.${BRANCH_SLUG}-docs.middlewares=gzip"
        - "traefik.http.routers.${BRANCH_SLUG}-docs.service=${BRANCH_SLUG}-docs"
        # Service configuration
        - "traefik.http.services.${BRANCH_SLUG}-docs.loadbalancer.server.port=80"
        # Middleware for HTTPS redirect
        - "traefik.http.middlewares.${BRANCH_SLUG}-docs-https-redirect.redirectscheme.scheme=https"
        - "traefik.http.middlewares.gzip.compress=true"
